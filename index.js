import express from 'express';
import { Telegraf, session } from 'telegraf';
import { OpenAI } from "openai";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI API —Å –∫–ª—é—á–æ–º

import dotenv from 'dotenv';

dotenv.config(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env

const BOT_TOKEN = process.env.BOT_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const openai = new OpenAI({ apiKey: OPENAI_API_KEY }); // –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∞
const WEBHOOK_URL = `https://telegbot-qgzu.onrender.com/webhook/${BOT_TOKEN}`; // –£–∫–∞–∂–∏ —Å–≤–æ–π –¥–æ–º–µ–Ω

if (!BOT_TOKEN || !OPENAI_API_KEY) {
    console.error('‚ùå ERROR: –£–±–µ–¥–∏—Å—å, —á—Ç–æ BOT_TOKEN –∏ OPENAI_API_KEY —É–∫–∞–∑–∞–Ω—ã –≤ .env');
    process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);
const app = express();
app.use(express.json());

// –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–µ—Å—Å–∏—é
bot.use(session());

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bot.use((ctx, next) => {
    if (!ctx.session) ctx.session = {
        messages: [
            {
                role: "system",
                content: "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ —Å—Ç—É–¥–∏–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∏ –≤–µ–±-–¥–∏–∑–∞–π–Ω–∞. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –≤—ã—è–≤–ª—è—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ —É–±–µ–∂–¥–∞—Ç—å –µ–≥–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É—Å–ª—É–≥–∞–º–∏ —Å—Ç—É–¥–∏–∏. –¢—ã –≤–µ–∂–ª–∏–≤, —É–±–µ–¥–∏—Ç–µ–ª–µ–Ω, –¥—Ä—É–∂–µ–ª—é–±–µ–Ω –∏ –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ—Å—Ç—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º.\n\n–¢—ã —É–º–µ–µ—à—å –ø—Ä–µ–∑–µ–Ω—Ç–æ–≤–∞—Ç—å —É—Å–ª—É–≥–∏, –æ–±—ä—è—Å–Ω—è—Ç—å –∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å. –¢—ã –∑–∞–¥–∞–µ—à—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —É—Å–ª—É–≥–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –µ–≥–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö.\n\n–¢—ã –Ω–µ –¥–∞–≤–∏—à—å, –Ω–æ –≤–µ–¥–µ—à—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ –ø—Ä–∏–Ω—è—Ç–∏—é —Ä–µ—à–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞—è, –∫–∞–∫ –¥–∏–∑–∞–π–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ –±—Ä–µ–Ω–¥, –ø—Ä–æ–¥–∞–∂–∏ –∏ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏. –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã –∏ –∫–µ–π—Å—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, –ø–æ—á–µ–º—É –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω ‚Äî —ç—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è, –∞ –Ω–µ —Ç—Ä–∞—Ç–∞ –¥–µ–Ω–µ–≥.\n\n–¢—ã –º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞, —Å–∫–∏–¥–∫–∏ (–µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ) –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞.\n\n–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è, —Ç—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏, –æ–±—ä—è—Å–Ω—è—è, –∫–∞–∫ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –ø–æ–º–æ–≥–∞–µ—Ç –±–∏–∑–Ω–µ—Å—É –≤—ã–¥–µ–ª—è—Ç—å—Å—è —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.\n\n–ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n- ¬´–î–∏–∑–∞–π–Ω ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å.¬ª\n- ¬´–í–∞—à —Å–∞–π—Ç ‚Äî —ç—Ç–æ –≤–∏–∑–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –±–∏–∑–Ω–µ—Å–∞. –ú—ã –ø–æ–º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º.¬ª\n- ¬´–õ–æ–≥–æ—Ç–∏–ø –∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –ø–µ—Ä–≤–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ –±—Ä–µ–Ω–¥–µ. –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è!¬ª\n- ¬´–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ —Å–∞–π—Ç, —Å—Ç–æ–∏—Ç –ø–æ–¥—É–º–∞—Ç—å –æ —Ö–æ—Ä–æ—à–µ–º UX/UI-–¥–∏–∑–∞–π–Ω–µ.¬ª\n- ¬´–Ø –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –±—é–¥–∂–µ—Ç–∞ –∏ –∑–∞–¥–∞—á.¬ª\n\n–¢—ã –∞–¥–∞–ø—Ç–∏—Ä—É–µ—à—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞: –µ—Å–ª–∏ –æ–Ω –≥–æ–≤–æ—Ä–∏—Ç —Ñ–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî —Ç—ã —Ç–æ–∂–µ —Ñ–æ—Ä–º–∞–ª–µ–Ω, –µ—Å–ª–∏ –æ–Ω –ø–∏—à–µ—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ ‚Äî —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –≤ —Ç–∞–∫–æ–º –∂–µ —Ç–æ–Ω–µ."
            }
        ]
    };
    return next();
});

await bot.telegram.setMyCommands([
    { command: "forget", description: "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏" }
]);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

bot.start((ctx) => ctx.reply('–Ø –≤–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é. \n–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã...üìú'));

bot.command('forget', async (ctx) => {
    ctx.session.messages = ctx.session.messages.slice(0, 1)
    await ctx.reply("üßπ –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–±—ã—Ç!")
})

bot.on('message', async (ctx) => {
    const messageText = ctx.message.text.trim();

    if (messageText.includes('/forget'))
        return;

    console.log(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${ctx.message.from.username}": ${messageText}`);

    const currentMessage = {
        role: "user",
        content: messageText
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    ctx.session.messages.push(currentMessage);

    const request = {
        model: "gpt-4o-mini",
        messages: ctx.session.messages
    }
    try {
        await ctx.sendChatAction('typing');
        const response = await openai.chat.completions.create(request);

        ctx.reply(response.choices[0].message.content);
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI:`, error);
        ctx.reply('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ üò¢');
    }
});

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Webhook 
app.post(`/webhook/${BOT_TOKEN}`, (req, res) => {
    bot.handleUpdate(req.body);
    res.sendStatus(200);
});

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
app.listen(3000, async () => {
    console.log('üöÄ Webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000');

    try {
        await bot.telegram.setWebhook(WEBHOOK_URL);
        console.log(`‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${WEBHOOK_URL}`);
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Webhook:', error);
    }
});
