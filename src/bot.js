import { Telegraf, session } from 'telegraf';
import { BOT_TOKEN } from './config.js';
import { askOpenAI } from './openai.js';

const bot = new Telegraf(BOT_TOKEN);
bot.use(session());

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
bot.use((ctx, next) => {
    if (!ctx.session) ctx.session = {
        messages: [
            {
                role: "system",
                content: "Ğ¢Ñ‹ â€” Ğ¾Ğ¿Ñ‹Ñ‚Ğ½Ñ‹Ğ¹ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ´ĞµĞ²ÑƒÑˆĞºĞ° Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°Ğ¼ ÑƒÑĞ»ÑƒĞ³ Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¸ Ğ²ĞµĞ±-Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ğ°. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ²Ñ‹ÑĞ²Ğ»ÑÑ‚ÑŒ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ, Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ñƒ Ğ¸ Ğ¼ÑĞ³ĞºĞ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°Ñ‚ÑŒ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ. Ğ¢Ñ‹ Ğ²ĞµĞ¶Ğ»Ğ¸Ğ²Ğ°, Ğ»Ğ°ĞºĞ¾Ğ½Ğ¸Ñ‡ĞµĞ½Ğ° Ğ¸ ÑƒĞ²ĞµÑ€ĞµĞ½ Ğ² ÑĞµĞ±Ğµ. ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ğ¾ĞºĞ¾ĞºĞµÑ‚Ğ½Ğ¸Ñ‡Ğ°Ñ‚ÑŒ. Ğ’ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ¹ Ğ»Ğ¸ÑˆĞ½Ğ¸Ñ… Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ², ÑÑ€Ğ°Ğ·Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸ Ğº ÑÑƒÑ‚Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°. Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼, Ğ±ĞµĞ· ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¾Ğ², Ğ½Ğ¾ Ñ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒÑ. Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº ÑĞ´ĞµĞ»ĞºĞµ, ÑĞ¾Ğ¾Ğ±Ñ‰Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ²ÑÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñˆ  Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¾Ğ½ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ñ Ğ½Ğ¸Ğ¼ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ ÑĞ²ÑĞ¶ĞµÑ‚ÑÑ. Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ²Ğ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ, ÑĞºĞ°Ğ¶Ğ¸, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ĞµÑ‰Ğµ ÑƒÑ‡Ğ¸ÑˆÑŒÑÑ, ÑÑ‚Ğ°Ñ€Ğ°ĞµÑˆÑŒÑÑ ÑÑ‚Ğ°Ñ‚ÑŒ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¸ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ±ÑƒĞ´ĞµÑˆÑŒ Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒÑÑ ĞµÑ‰Ğµ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½ĞµĞµ, Ğ° Ñ‚Ğ°ĞºĞ¶ Ğ¿Ğ¾Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ğ¸ Ğ·Ğ° ÑƒĞ´ĞµĞ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ."
            }
        ]
    };
    return next();
});

// Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
await bot.telegram.setMyCommands([
    { command: "forget", description: "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸" }
]);

bot.start((ctx) => ctx.reply('ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ§ĞµĞ¼ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ? ğŸ˜Š'));

bot.command('forget', async (ctx) => {
    ctx.session.messages = [];
    await ctx.reply("ğŸ§¹ ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ·Ğ°Ğ±Ñ‹Ñ‚!");
});

bot.on('message', async (ctx) => {
    const messageText = ctx.message.text.trim();
    if (!messageText) return;

    console.log(`ğŸ‘¤ ${ctx.message.from.username}: ${messageText}`);

    const currentMessage = { role: "user", content: messageText };
    ctx.session.messages.push(currentMessage);

    await ctx.sendChatAction('typing');
    const reply = await askOpenAI(ctx.session.messages);

    ctx.reply(reply);
});

export default bot;
